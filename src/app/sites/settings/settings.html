<mat-card appearance="outlined">
  <mat-card-header>
    <mat-card-title>Administración</mat-card-title>
    <mat-card-subtitle>Configurar usuarios, roles, namespaces y procesos</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <ng-container *ngIf="canViewRbac; else notAllowedTpl">
      <app-rbac-component></app-rbac-component>
    </ng-container>
    <ng-template #notAllowedTpl>
      <div style="padding:12px; color:rgba(0,0,0,.6)">No tienes permisos para ver esta sección.</div>
    </ng-template>
  </mat-card-content>
</mat-card>

<!--
<mat-card appearance="outlined">
  <mat-card-header>
    <mat-card-title>Notificaciones</mat-card-title>
    <mat-card-subtitle>Configura alertas y notificaciones del sistema</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div style="margin:12px 0; padding:12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06);">
      <section style="display:grid; grid-template-columns: 1fr 2fr; gap:16px; margin-bottom:16px;">
        <div>
          <h3 style="margin:0 0 8px;">Preferencias</h3>

          <div style="margin-bottom:8px;">Recibir por correo electrónico: <strong>Sí</strong></div>

          <div style="margin-top:12px;">
            <div style="width:100%;">
              <label style="display:block; font-weight:600; margin-bottom:6px;">Severidad mínima</label>
              <div>INFO • WARNING • SECURITY • SYSTEM</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label style="display:block; font-weight:600; margin-bottom:6px;">Namespaces</label>
            <div style="display:flex; gap:8px;"><mat-chip color="primary" selected>inteligencia_comercial</mat-chip><mat-chip color="primary" selected>marketing</mat-chip></div>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px;">
            <button mat-stroked-button color="primary">Guardar preferencias</button>
            <button mat-button>Probar notificación</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px;">Recientes</h3>
          <mat-divider></mat-divider>

          <div style="display:flex; gap:8px; align-items:center; margin:12px 0;">
            <button mat-stroked-button color="primary">Marcar todas como leídas</button>
          </div>

          <mat-list>
            <mat-list-item>
              <mat-icon matListItemIcon>notifications</mat-icon>
              <div matListItemTitle style="display:flex; gap:8px; align-items:center;"><span style="font-weight:600">Evento crítico</span><mat-chip color="primary" selected>Nuevo</mat-chip></div>
              <div matListItemLine style="opacity:.85">Se detectó un evento crítico en la cola X.</div>
              <div matListItemLine style="font-size:12px; opacity:.6;">Hace 2 horas</div>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>notifications</mat-icon>
              <div matListItemTitle style="display:flex; gap:8px; align-items:center;"><span style="font-weight:400">Backup completado</span></div>
              <div matListItemLine style="opacity:.85">El backup diario finalizó correctamente.</div>
              <div matListItemLine style="font-size:12px; opacity:.6;">Ayer</div>
            </mat-list-item>
          </mat-list>
        </div>
      </section>
    </div>
  </mat-card-content>
</mat-card>
-->
<mat-card appearance="outlined">
  <mat-card-header>
    <mat-card-title>Seguridad</mat-card-title>
    <mat-card-subtitle>Gestión de sesiones y alcance por namespace</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div style="margin:12px 0; padding:12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06);">
      <h2 style="margin:0 0 12px; display:flex; align-items:center; gap:8px;"><mat-icon>manage_accounts</mat-icon> Sesiones activas</h2>

  <div style="margin-bottom:12px; display:flex; justify-content:flex-end;"><button mat-stroked-button color="warn" (click)="revokeOtherSessions()">Cerrar otras sesiones</button></div>

      <table class="mat-elevation-z1" style="width:100%">
        <thead>
          <tr>
            <th>Dispositivo</th>
            <th>IP</th>
            <th>Ubicación</th>
            <th>Última actividad</th>
            <th>Actual</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody *ngIf="!loadingSessions && sessions.length; else noSessionsTpl">
          <tr *ngFor="let s of sessions">
            <td>
              <div style="display:flex; align-items:center; gap:8px;">
                <mat-icon>{{ getDeviceIcon(s.os) }}</mat-icon>
                <div>
                  <div style="font-weight:600">{{ s.os || 'Dispositivo' }}</div>
                  <div style="font-size:12px; opacity:.7">{{ s.userAgent }}</div>
                </div>
              </div>
            </td>
            <td>{{ s.ipAddress || '—' }}</td>
            <td>—</td>
            <td>{{ s.lastAccessAt ? (s.lastAccessAt | date:'short') : (s.issuedAt ? (s.issuedAt | date:'short') : '—') }}</td>
            <td>
              <mat-icon *ngIf="s.jti === currentJti" color="primary">check_circle</mat-icon>
            </td>
            <td><button mat-button color="warn" (click)="revokeSession(s.jti)" [disabled]="s.jti === currentJti">Cerrar</button></td>
          </tr>
        </tbody>
        <ng-template #noSessionsTpl>
          <tbody>
            <tr><td colspan="6" style="padding:16px; text-align:center;">No hay sesiones activas registradas.</td></tr>
          </tbody>
        </ng-template>
      </table>

      <mat-divider style="margin:12px 0;"></mat-divider>

      <section>
        <h3 style="margin:16px 0 8px; display:flex; align-items:center; gap:8px;"><mat-icon>domain</mat-icon> Alcance por namespace</h3>

        <!-- global flags -->
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
          <div *ngFor="let key of (globalKeys | slice:0:10)">
            <mat-chip color="accent" selected *ngIf="globalScope[key]">{{ key.replace('global_','') | uppercase }} (global)</mat-chip>
          </div>
        </div>

        <div style="display:grid; gap:12px;">
          <div *ngIf="namespaceScope?.length; else noNsTpl">
            <div *ngFor="let ns of namespaceScope" class="scope-card" style="padding:12px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;">
              <div class="scope-title" style="display:flex; align-items:center; gap:8px;">
                <div class="ns-badge" style="font-weight:700">{{ ns.name }}</div>
                <div style="flex:1 1 auto"></div>
                <div style="font-size:12px; opacity:.8">Actions: {{ ns.actions.join(', ') }}</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <mat-chip *ngFor="let a of ns.actions" color="primary" selected>{{ a }}</mat-chip>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noNsTpl>
          <div style="padding:12px; color:rgba(0,0,0,.6)">No tienes alcance por namespace o no hay namespaces asignados.</div>
        </ng-template>
      </section>
    </div>
  </mat-card-content>
</mat-card>