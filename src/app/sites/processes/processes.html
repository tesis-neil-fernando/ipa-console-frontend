<div class="processes-container">
  <div *ngIf="loading" class="processes-loading">
    <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
    <div>Cargando procesos...</div>
  </div>
  <div *ngIf="error" class="processes-error">
    <mat-card class="error-card" appearance="outlined">
      <mat-card-header>
        <mat-card-title>Error</mat-card-title>
        <mat-card-subtitle>{{ error }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-actions>
        <button mat-button (click)="loadProcesses()">Reintentar</button>
      </mat-card-actions>
    </mat-card>
  </div>
  <div class="processes-actions" *ngIf="!loading && !error">
    <div class="tools-bar">
      <button mat-icon-button aria-label="Refrescar procesos" (click)="loadProcesses()" [disabled]="loading"
        title="Refrescar">
        <mat-icon>refresh</mat-icon>
      </button>
      <mat-checkbox class="ejecutable-btn" [(ngModel)]="showOnlyExecutable">Ejecutable</mat-checkbox>
      <!-- future tool buttons can go here -->
    </div>
  </div>

  <div class="processes-main" *ngIf="!loading && !error">
    <div class="processes-list">
      <mat-card *ngFor="let process of displayedProcesses" class="process-card" appearance="outlined">
        <mat-card-header>
          <mat-card-title>{{ process.name }}</mat-card-title>
          <mat-card-subtitle>{{ process.workflowName }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>
            {{ process.description }}
          </p>
        </mat-card-content>
        <mat-card-actions>
          <button matButton>
            <mat-icon>check</mat-icon>
            {{ process.active }}
          </button>
          <button matButton>
            <mat-icon>schedule</mat-icon>
            {{ process.status }} • {{ formatTimeAgo(process.startedAt) }}
          </button>
          <span class="example-spacer"></span>
          <button matIconButton class="icon-button" aria-label="Abrir configuración" (click)="selectProcess(process)">
            <mat-icon>settings</mat-icon>
          </button>
          <button matIconButton class="icon-button" aria-label="Ejecutar proceso" (click)="startProcess(process)"
            [disabled]="!process.canExecute || isStarting(process)">
            <mat-icon *ngIf="!isStarting(process)">play_arrow</mat-icon>
            <mat-icon *ngIf="isStarting(process)">autorenew</mat-icon>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
    <div class="process-config">
      <mat-card class="config-card" appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            Configuración de proceso
            <span *ngIf="!selectedProcess"> [sin seleccionar]</span>
          </mat-card-title>
          <mat-card-subtitle>Detalles y configuraciones</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="!selectedProcess">
            <p>Selecciona un proceso para ver sus detalles de configuración aquí.</p>
          </div>

          <div *ngIf="selectedProcess">

            <!-- Name and Description have been removed from this editor and are not sent to the backend -->

            <div class="params-list">
              <div *ngFor="let p of editedParameters" class="param-row">
                <!-- Boolean parameters are rendered as a checkbox with label so the name is visible -->
                <ng-container *ngIf="(p.type || '').toString().toLowerCase() === 'boolean'">
                  <div style="display:flex;align-items:center;gap:8px;width:100%">
                    <mat-checkbox [(ngModel)]="p.value" name="param-{{p.id}}">{{ p.name }}</mat-checkbox>

                    <span class="example-spacer"></span>

                    <!-- Cron help (unlikely for boolean but keep check) -->
                    <button *ngIf="isCronParam(p)" mat-icon-button color="primary" aria-label="Ayuda formato cron"
                      (click)="openCronHelp(p)" type="button" matTooltip="Formato cron — Ver documentación">
                      <mat-icon>help</mat-icon>
                    </button>

                    <!-- Delete is hidden for cron and for protected names (Programado / Programación) -->
                    <button *ngIf="!isCronParam(p) && !isProtectedParam(p)" mat-icon-button color="warn" aria-label="Eliminar parámetro"
                      (click)="p.id ? deleteParameter(p) : removeLocalParameter(p)" type="button">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </ng-container>

                <!-- Other parameter types: text/number input -->
                <ng-container *ngIf="(p.type || '').toString().toLowerCase() !== 'boolean'">
                  <mat-form-field appearance="fill" style="width:100%">
                    <mat-label>{{ p.name }}</mat-label>
                    <input matInput [type]="p.type === 'number' ? 'number' : 'text'" [(ngModel)]="p.value"
                      name="param-{{p.id}}">

                    <!-- Cron help (when parameter type is cron) -->
                    <button *ngIf="isCronParam(p)" mat-icon-button matSuffix color="primary"
                      aria-label="Ayuda formato cron" (click)="openCronHelp(p)" type="button" matTooltip="Formato cron — Ver documentación">
                      <mat-icon>help</mat-icon>
                    </button>

                    <!-- Delete is hidden for cron and for protected names (Programado / Programación) -->
                    <button *ngIf="!isCronParam(p) && !isProtectedParam(p)" mat-icon-button matSuffix color="warn" aria-label="Eliminar parámetro"
                      (click)="p.id ? deleteParameter(p) : removeLocalParameter(p)" type="button">
                      <mat-icon>delete</mat-icon>
                    </button>
                    <!-- Inline cron validation error -->
                    <mat-error *ngIf="isCronParam(p) && !isCronValid(p) && (p.value || '')">Formato cron inválido</mat-error>
                  </mat-form-field>
                </ng-container>
              </div>

              <div class="add-param-row" style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <mat-form-field appearance="fill" style="flex:1">
                  <mat-label>Nuevo parámetro (nombre)</mat-label>
                  <input matInput [(ngModel)]="newParamName" name="new-param-name">
                </mat-form-field>
                <button mat-flat-button color="primary" (click)="addParameter()" [disabled]="!newParamName">Agregar</button>
              </div>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions *ngIf="selectedProcess">
          <span class="example-spacer"></span>
          <button mat-flat-button color="primary" (click)="updateSelectedProcess()" [disabled]="!isAllCronValid()">Actualizar</button>
          <button mat-button (click)="cancelEdit()">Cancelar</button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>